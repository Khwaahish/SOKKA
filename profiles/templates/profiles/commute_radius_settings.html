{% extends 'profiles/base.html' %}

{% block title %}Commute Radius Settings{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  #location-map {
    height: 500px;
    width: 100%;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    margin-bottom: 1rem;
  }
  .radius-circle {
    border: 2px dashed #0d6efd;
    border-radius: 50%;
    background-color: rgba(13, 110, 253, 0.1);
  }
  .info-box {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.375rem;
    border: 1px solid #dee2e6;
    margin-bottom: 1rem;
  }
  .radius-display {
    font-size: 1.5rem;
    font-weight: bold;
    color: #0d6efd;
  }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-map-marker-alt"></i> Commute Radius Settings</h2>
                <p class="mb-0 text-muted">Set your preferred location and commute radius to see only jobs within a reasonable travel distance</p>
            </div>
            <div class="card-body">
                <form method="post" id="commute-radius-form">
                    {% csrf_token %}
                    
                    <div class="info-box">
                        <h5><i class="fas fa-info-circle"></i> How it works</h5>
                        <p class="mb-0">Click on the map to set your preferred location, then adjust the commute radius slider. Only jobs within your selected radius will be shown in job listings (remote jobs are always included).</p>
                    </div>

                    <!-- Map for selecting location -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-map"></i> Select Your Preferred Location
                        </label>
                        <p class="text-muted">Click anywhere on the map to set your location</p>
                        <div id="location-map"></div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="locateUser()">
                                <i class="fas fa-crosshairs"></i> Use My Current Location
                            </button>
                            <span id="location-status" class="ms-2 text-muted"></span>
                        </div>
                    </div>

                    <!-- Hidden fields for coordinates -->
                    {{ form.latitude }}
                    {{ form.longitude }}

                    <!-- Commute Radius Input -->
                    <div class="mb-4">
                        <label for="{{ form.commute_radius.id_for_label }}" class="form-label fw-bold">
                            <i class="fas fa-circle-notch"></i> Commute Radius (miles)
                        </label>
                        <div class="d-flex align-items-center gap-3">
                            <input 
                                type="range" 
                                class="form-range" 
                                id="radius-slider"
                                min="1" 
                                max="100" 
                                step="1"
                                value="{{ form.commute_radius.value|default:10 }}"
                                oninput="updateRadiusDisplay(this.value)"
                            >
                            <div class="radius-display" id="radius-display">
                                {{ form.commute_radius.value|default:10 }} miles
                            </div>
                        </div>
                        {{ form.commute_radius }}
                        {% if form.commute_radius.errors %}
                            <div class="text-danger">{{ form.commute_radius.errors }}</div>
                        {% endif %}
                        <div class="form-text">Adjust the slider to set your preferred commute radius (1-100 miles)</div>
                    </div>

                    <!-- Location Name (Optional) -->
                    <div class="mb-4">
                        <label for="{{ form.location_name.id_for_label }}" class="form-label fw-bold">
                            <i class="fas fa-map-pin"></i> Location Name (Optional)
                        </label>
                        {{ form.location_name }}
                        {% if form.location_name.errors %}
                            <div class="text-danger">{{ form.location_name.errors }}</div>
                        {% endif %}
                        <div class="form-text">A friendly name for your location (e.g., "San Francisco, CA" or "Home")</div>
                    </div>

                    <!-- Form Actions -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'profiles:profile_detail' %}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-arrow-left"></i> Back to Profile
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Commute Radius Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map;
let locationMarker = null;
let radiusCircle = null;
let currentLat = {{ current_latitude|default:"null" }};
let currentLon = {{ current_longitude|default:"null" }};
let currentRadius = {{ current_radius|default:10 }};

// Initialize map
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    updateRadiusDisplay(currentRadius);
    document.getElementById('id_commute_radius').value = currentRadius;
    document.getElementById('radius-slider').value = currentRadius;
});

function initMap() {
    // Default center (San Francisco) or use saved location
    const defaultLat = currentLat || 37.7749;
    const defaultLon = currentLon || -122.4194;
    const defaultZoom = currentLat ? 12 : 2;

    map = L.map('location-map').setView([defaultLat, defaultLon], defaultZoom);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);

    // If user has saved location, show it
    if (currentLat && currentLon) {
        setLocation(currentLat, currentLon, false);
    }

    // Handle map clicks
    map.on('click', function(e) {
        setLocation(e.latlng.lat, e.latlng.lng, true);
    });
}

function setLocation(lat, lon, updateForm = true) {
    currentLat = lat;
    currentLon = lon;

    // Update hidden form fields
    if (updateForm) {
        document.getElementById('id_latitude').value = lat;
        document.getElementById('id_longitude').value = lon;
    }

    // Remove existing marker
    if (locationMarker) {
        map.removeLayer(locationMarker);
    }

    // Add new marker
    locationMarker = L.marker([lat, lon], {
        draggable: true,
        icon: L.divIcon({
            className: 'user-location-marker',
            html: '<div style="background-color: #0d6efd; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 0 2px #0d6efd;"></div>',
            iconSize: [20, 20]
        })
    })
    .addTo(map)
    .bindPopup('Your Preferred Location')
    .openPopup();

    // Handle marker drag
    locationMarker.on('dragend', function(e) {
        const position = e.target.getLatLng();
        setLocation(position.lat, position.lng, true);
    });

    // Update radius circle
    updateRadiusCircle();

    // Center map on location
    map.setView([lat, lon], 12);

    // Try to reverse geocode for location name
    reverseGeocode(lat, lon);
}

function updateRadiusCircle() {
    if (!currentLat || !currentLon) return;

    const radiusMiles = parseFloat(document.getElementById('radius-slider').value);
    const radiusMeters = radiusMiles * 1609.34; // Convert miles to meters

    // Remove existing circle
    if (radiusCircle) {
        map.removeLayer(radiusCircle);
    }

    // Add new circle
    radiusCircle = L.circle([currentLat, currentLon], {
        radius: radiusMeters,
        color: '#0d6efd',
        fillColor: '#0d6efd',
        fillOpacity: 0.1,
        weight: 2,
        dashArray: '5, 5'
    }).addTo(map);
}

function updateRadiusDisplay(value) {
    const display = document.getElementById('radius-display');
    display.textContent = value + ' miles';
    document.getElementById('id_commute_radius').value = value;
    updateRadiusCircle();
}

function locateUser() {
    const statusEl = document.getElementById('location-status');
    statusEl.textContent = 'Locating...';

    if (!navigator.geolocation) {
        statusEl.textContent = 'Geolocation is not supported by your browser';
        return;
    }

    navigator.geolocation.getCurrentPosition(
        function(position) {
            setLocation(position.coords.latitude, position.coords.longitude, true);
            statusEl.textContent = 'Location found!';
            statusEl.className = 'ms-2 text-success';
        },
        function(error) {
            statusEl.textContent = 'Unable to get your location: ' + error.message;
            statusEl.className = 'ms-2 text-danger';
        }
    );
}

function reverseGeocode(lat, lon) {
    // Use Nominatim API for reverse geocoding
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data && data.address) {
                const address = data.address;
                let locationName = '';
                
                // Try to build a friendly location name
                if (address.city) {
                    locationName = address.city;
                    if (address.state) {
                        locationName += ', ' + address.state;
                    } else if (address.country) {
                        locationName += ', ' + address.country;
                    }
                } else if (address.town) {
                    locationName = address.town;
                    if (address.state) {
                        locationName += ', ' + address.state;
                    }
                } else if (address.village) {
                    locationName = address.village;
                } else if (address.country) {
                    locationName = address.country;
                }
                
                if (locationName) {
                    document.getElementById('id_location_name').value = locationName;
                }
            }
        })
        .catch(error => {
            console.error('Reverse geocoding error:', error);
        });
}

// Ensure form has coordinates before submission
document.getElementById('commute-radius-form').addEventListener('submit', function(e) {
    const lat = document.getElementById('id_latitude').value;
    const lon = document.getElementById('id_longitude').value;
    
    if (!lat || !lon) {
        e.preventDefault();
        alert('Please select a location on the map before saving.');
        return false;
    }
});
</script>
{% endblock %}

