{% extends 'profiles/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  #location-map {
    width: 100%;
    height: 400px;
    border-radius: 8px;
    border: 2px solid #dee2e6;
    margin-top: 10px;
  }
  
  .map-container {
    margin: 20px 0;
  }
  
  .map-instructions {
    background-color: #e7f3ff;
    border-left: 4px solid #0d6efd;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 4px;
  }
  
  .location-marker-info {
    background-color: #f8f9fa;
    padding: 10px;
    border-radius: 4px;
    margin-top: 10px;
    font-size: 0.9em;
  }
  
  .form-group input[type="text"],
  .form-group input[type="email"],
  .form-group textarea,
  .form-group select {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 1rem;
  }
</style>
{% endblock %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-user-edit"></i> {{ title }}</h2>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.first_name.id_for_label }}" class="form-label">First Name *</label>
                                {{ form.first_name }}
                                {% if form.first_name.errors %}
                                    <div class="text-danger">{{ form.first_name.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.last_name.id_for_label }}" class="form-label">Last Name *</label>
                                {{ form.last_name }}
                                {% if form.last_name.errors %}
                                    <div class="text-danger">{{ form.last_name.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.email.id_for_label }}" class="form-label">Email *</label>
                        {{ form.email }}
                        {% if form.email.errors %}
                            <div class="text-danger">{{ form.email.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.headline.id_for_label }}" class="form-label">Professional Headline *</label>
                        {{ form.headline }}
                        {% if form.headline.errors %}
                            <div class="text-danger">{{ form.headline.errors }}</div>
                        {% endif %}
                        <div class="form-text">e.g., Software Engineer, Marketing Manager, Data Scientist</div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.bio.id_for_label }}" class="form-label">Professional Summary</label>
                        {{ form.bio }}
                        {% if form.bio.errors %}
                            <div class="text-danger">{{ form.bio.errors }}</div>
                        {% endif %}
                        <div class="form-text">Write a brief summary of your professional background and career goals.</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.phone.id_for_label }}" class="form-label">Phone</label>
                                {{ form.phone }}
                                {% if form.phone.errors %}
                                    <div class="text-danger">{{ form.phone.errors }}</div>
                                {% endif %}
                                <div class="form-text">e.g., +1 (555) 123-4567</div>
                            </div>
                        </div>
                    </div>

                    <!-- Location Pinning Section -->
                    <div class="map-container">
                        <h4 class="mb-3">
                            <i class="fas fa-map-marker-alt"></i> Set Your Location
                        </h4>
                        
                        <div class="map-instructions">
                            <strong><i class="fas fa-info-circle"></i> Instructions:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Click on the map to pin your location</li>
                                <li>You can drag the marker to adjust the position</li>
                                <li>Use the "Use My Current Location" button to quickly set your location</li>
                                <li>Type a location name and click "Search & Pin Location" to find it on the map</li>
                                <li><strong>Setting your location helps recruiters find you!</strong></li>
                            </ul>
                        </div>
                        
                        <!-- Location Name Field -->
                        <div class="mb-3">
                            <label for="{{ form.location.id_for_label }}" class="form-label">Location Name</label>
                            {{ form.location }}
                            <small class="form-text text-muted">This will be auto-filled when you pin a location, or you can type it manually and search</small>
                            {% if form.location.errors %}
                                <div class="text-danger small">{{ form.location.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- Map -->
                        <div id="location-map"></div>
                        
                        <!-- Location Status -->
                        <div class="location-marker-info" id="location-status">
                            <i class="fas fa-map-pin"></i> 
                            <span id="location-status-text">Click on the map to set your location</span>
                        </div>
                        
                        <!-- Use Current Location Button -->
                        <button type="button" class="btn btn-outline-primary mt-2" id="locate-btn">
                            <i class="fas fa-crosshairs"></i> Use My Current Location
                        </button>
                        
                        <!-- Hidden fields for coordinates -->
                        {{ form.latitude }}
                        {{ form.longitude }}
                        
                        {% if form.latitude.errors or form.longitude.errors %}
                            <div class="text-danger small mt-2">
                                {% if form.latitude.errors %}{{ form.latitude.errors }}{% endif %}
                                {% if form.longitude.errors %}{{ form.longitude.errors }}{% endif %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.profile_picture.id_for_label }}" class="form-label">Profile Picture</label>
                        {{ form.profile_picture }}
                        {% if form.profile_picture.errors %}
                            <div class="text-danger">{{ form.profile_picture.errors }}</div>
                        {% endif %}
                        <div class="form-text">Upload a professional headshot (optional)</div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'profiles:profile_detail' %}" class="btn btn-secondary me-md-2">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Profile
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
var map;
var locationMarker = null;
var currentLat = null;
var currentLon = null;

// Get initial values from form or use defaults
var locationField = document.getElementById('{{ form.location.id_for_label }}');
var latitudeField = document.getElementById('{{ form.latitude.id_for_label }}');
var longitudeField = document.getElementById('{{ form.longitude.id_for_label }}');
var locationStatusText = document.getElementById('location-status-text');
var mapContainer = document.getElementById('location-map');

// Get initial coordinates from data attributes or form values
if (mapContainer) {
    var initialLat = mapContainer.getAttribute('data-initial-lat');
    var initialLon = mapContainer.getAttribute('data-initial-lon');
    if (initialLat && initialLon) {
        currentLat = parseFloat(initialLat);
        currentLon = parseFloat(initialLon);
    } else if (latitudeField && longitudeField && latitudeField.value && longitudeField.value) {
        currentLat = parseFloat(latitudeField.value);
        currentLon = parseFloat(longitudeField.value);
    }
}

// Initialize map when page loads
document.addEventListener('DOMContentLoaded', function() {
    initMap();
});

function initMap() {
    // Default center (San Francisco) or use saved location
    var defaultLat = currentLat || 37.7749;
    var defaultLon = currentLon || -122.4194;
    var defaultZoom = currentLat ? 12 : 2;

    map = L.map('location-map').setView([defaultLat, defaultLon], defaultZoom);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);

    // If user has saved location, show it
    if (currentLat && currentLon) {
        setLocation(currentLat, currentLon, false);
    }

    // Handle map clicks
    map.on('click', function(e) {
        setLocation(e.latlng.lat, e.latlng.lng, true);
    });
}

function setLocation(lat, lon, updateForm = true) {
    // Round to 7 decimal places to match form validation
    currentLat = Math.round(lat * 10000000) / 10000000;
    currentLon = Math.round(lon * 10000000) / 10000000;

    // Update hidden form fields with properly rounded values
    if (updateForm && latitudeField && longitudeField) {
        latitudeField.value = currentLat.toFixed(7);
        longitudeField.value = currentLon.toFixed(7);
    }

    // Remove existing marker
    if (locationMarker) {
        map.removeLayer(locationMarker);
    }

    // Add new marker using rounded coordinates
    locationMarker = L.marker([currentLat, currentLon], {
        draggable: true,
        icon: L.divIcon({
            className: 'user-location-marker',
            html: '<div style="background-color: #28a745; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
            iconSize: [24, 24]
        })
    })
    .addTo(map)
    .bindPopup('Your Location')
    .openPopup();

    // Handle marker drag
    locationMarker.on('dragend', function(e) {
        var position = e.target.getLatLng();
        setLocation(position.lat, position.lng, true);
    });

    // Center map on location
    map.setView([currentLat, currentLon], 12);

    // Update status
    if (locationStatusText) {
        locationStatusText.textContent = 'Location pinned at: ' + currentLat.toFixed(7) + ', ' + currentLon.toFixed(7);
        locationStatusText.parentElement.style.backgroundColor = '#d4edda';
        locationStatusText.parentElement.style.borderLeft = '4px solid #28a745';
    }

    // Try to reverse geocode for location name
    reverseGeocode(currentLat, currentLon);
}

function reverseGeocode(lat, lon) {
    // Use Nominatim API for reverse geocoding
    var url = 'https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lon + '&zoom=18&addressdetails=1';
    
    fetch(url)
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data && data.address && locationField) {
                var address = data.address;
                var locationName = '';
                
                // Try to build a friendly location name
                if (address.city) {
                    locationName = address.city;
                    if (address.state) {
                        locationName += ', ' + address.state;
                    } else if (address.country) {
                        locationName += ', ' + address.country;
                    }
                } else if (address.town) {
                    locationName = address.town;
                    if (address.state) {
                        locationName += ', ' + address.state;
                    }
                } else if (address.village) {
                    locationName = address.village;
                } else if (address.country) {
                    locationName = address.country;
                }
                
                if (locationName && (!locationField.value || locationField.dataset.autoFilled === 'true')) {
                    locationField.value = locationName;
                    locationField.dataset.autoFilled = 'true';
                }
            }
        })
        .catch(function(error) {
            console.error('Reverse geocoding error:', error);
        });
}

function locateUser() {
    var statusEl = document.getElementById('location-status-text');
    if (statusEl) {
        statusEl.textContent = 'Locating...';
    }

    if (!navigator.geolocation) {
        if (statusEl) {
            statusEl.textContent = 'Geolocation is not supported by your browser';
        }
        return;
    }

    navigator.geolocation.getCurrentPosition(
        function(position) {
            setLocation(position.coords.latitude, position.coords.longitude, true);
            if (statusEl) {
                statusEl.textContent = 'Location found!';
            }
        },
        function(error) {
            if (statusEl) {
                statusEl.textContent = 'Unable to get your location: ' + error.message;
                statusEl.parentElement.style.backgroundColor = '#f8d7da';
                statusEl.parentElement.style.borderLeft = '4px solid #dc3545';
            }
        }
    );
}

// Function to geocode location name and set map location
function geocodeLocationName(locationName) {
    if (!locationName || !locationName.trim()) {
        return;
    }
    
    var statusEl = document.getElementById('location-status-text');
    if (statusEl) {
        statusEl.textContent = 'Searching for location...';
    }
    
    // Use Nominatim API for geocoding
    var url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(locationName) + '&limit=1';
    
    fetch(url)
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data && data.length > 0) {
                var result = data[0];
                var lat = parseFloat(result.lat);
                var lon = parseFloat(result.lon);
                setLocation(lat, lon, true);
                if (statusEl) {
                    statusEl.textContent = 'Location found and pinned!';
                }
            } else {
                if (statusEl) {
                    statusEl.textContent = 'Location not found. Please try a different search term or click on the map.';
                    statusEl.parentElement.style.backgroundColor = '#fff3cd';
                    statusEl.parentElement.style.borderLeft = '4px solid #ffc107';
                }
            }
        })
        .catch(function(error) {
            console.error('Geocoding error:', error);
            if (statusEl) {
                statusEl.textContent = 'Error searching location. Please click on the map to set location.';
                statusEl.parentElement.style.backgroundColor = '#f8d7da';
                statusEl.parentElement.style.borderLeft = '4px solid #dc3545';
            }
        });
}

// Attach locate button
if (document.getElementById('locate-btn')) {
    document.getElementById('locate-btn').addEventListener('click', locateUser);
}

// Add geocoding when location field loses focus or search button is clicked
if (locationField) {
    // Clear auto-filled flag when user types
    locationField.addEventListener('input', function() {
        this.dataset.autoFilled = 'false';
    });
    
    // Add search button
    var locationGroup = locationField.closest('.mb-3');
    if (locationGroup) {
        var searchBtn = document.createElement('button');
        searchBtn.type = 'button';
        searchBtn.className = 'btn btn-sm btn-outline-primary mt-2';
        searchBtn.innerHTML = '<i class="fas fa-search"></i> Search & Pin Location';
        searchBtn.onclick = function() {
            var locationName = locationField.value.trim();
            if (locationName) {
                geocodeLocationName(locationName);
            } else {
                alert('Please enter a location name first.');
            }
        };
        locationGroup.appendChild(searchBtn);
    }
}
</script>
{% endblock %}

