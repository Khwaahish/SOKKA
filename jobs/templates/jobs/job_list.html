{% extends "profiles/base.html" %}
{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  #job-map {
    height: 600px;
    width: 100%;
    border-radius: 8px;
    border: 1px solid #dee2e6;
  }
  .view-toggle {
    display: flex;
    gap: 0.5rem;
  }
  .view-toggle .btn {
    border-radius: 0.375rem;
  }
  .job-marker-popup {
    max-width: 300px;
  }
  .job-marker-popup h6 {
    margin-bottom: 0.5rem;
    color: #0d6efd;
  }
  .job-marker-popup .badge {
    margin-right: 0.25rem;
  }
  #map-container {
    display: none;
  }
  #list-container {
    display: block;
  }
  .view-toggle .btn.active {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
  }
  #distance-filter-container {
    padding: 0.5rem;
    background-color: #f8f9fa;
    border-radius: 0.375rem;
    border: 1px solid #dee2e6;
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1>Job Listings</h1>
  <div class="d-flex align-items-center gap-3">
    <div class="view-toggle">
      <button type="button" class="btn btn-outline-primary active" id="list-view-btn" onclick="switchView('list')">
        <i class="fas fa-list"></i> List View
      </button>
      <button type="button" class="btn btn-outline-primary" id="map-view-btn" onclick="switchView('map')">
        <i class="fas fa-map"></i> Map View
      </button>
    </div>
    {% if user.is_authenticated %}
      <a href="{% url 'jobs:create' %}" class="btn btn-success">Post a Job</a>
    {% endif %}
  </div>
</div>

{% if has_commute_radius %}
<div class="alert alert-info d-flex justify-content-between align-items-center mb-3">
  <div>
    <i class="fas fa-info-circle"></i> 
    <strong>Commute Radius Filter Active:</strong> Showing jobs within {{ commute_radius_miles }} miles of your preferred location (remote jobs always included).
  </div>
  <a href="{% url 'profiles:commute_radius_settings' %}" class="btn btn-sm btn-outline-primary">
    <i class="fas fa-cog"></i> Change Settings
  </a>
</div>
{% elif user.is_authenticated and user.user_profile.is_job_seeker %}
<div class="alert alert-secondary d-flex justify-content-between align-items-center mb-3">
  <div>
    <i class="fas fa-map-marker-alt"></i> 
    <strong>Tip:</strong> Set your commute radius to see only jobs within a reasonable travel distance.
  </div>
  <a href="{% url 'profiles:commute_radius_settings' %}" class="btn btn-sm btn-primary">
    <i class="fas fa-cog"></i> Set Commute Radius
  </a>
</div>
{% endif %}

<form method="get" class="row g-2 mb-4">
  <div class="col-md-3">
    <input class="form-control" type="text" name="title" placeholder="Title" value="{{ request.GET.title }}">
  </div>
  <div class="col-md-3">
    <input class="form-control" type="text" name="skills" placeholder="Skills (comma separated)" value="{{ request.GET.skills }}">
  </div>
  <div class="col-md-2">
    <input class="form-control" type="text" name="location" placeholder="Location" value="{{ request.GET.location }}">
  </div>
  <div class="col-md-1">
    <input class="form-control" type="number" name="salary_min" placeholder="Min" value="{{ request.GET.salary_min }}">
  </div>
  <div class="col-md-1">
    <input class="form-control" type="number" name="salary_max" placeholder="Max" value="{{ request.GET.salary_max }}">
  </div>
  <div class="col-md-2 d-flex align-items-center">
    <div class="form-check me-3">
      <input class="form-check-input" type="checkbox" name="is_remote" value="1" id="id_remote" {% if request.GET.is_remote %}checked{% endif %}>
      <label class="form-check-label" for="id_remote">Remote</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" name="visa_sponsorship" value="1" id="id_visa" {% if request.GET.visa_sponsorship %}checked{% endif %}>
      <label class="form-check-label" for="id_visa">Visa Sponsorship</label>
    </div>
  </div>
  <div class="col-12">
    <button type="submit" class="btn btn-primary">Filter</button>
  </div>
</form>

<!-- List View -->
<div id="list-container">
  <div id="list-distance-filter-container" class="mb-3 d-none align-items-center gap-2" style="padding: 0.5rem; background-color: #f8f9fa; border-radius: 0.375rem; border: 1px solid #dee2e6;">
    <label for="list-distance-filter" class="form-label mb-0">
      <i class="fas fa-filter"></i> Filter by distance:
    </label>
    <select id="list-distance-filter" class="form-select form-select-sm" style="width: auto;" onchange="filterListByDistance()">
      <option value="">Show all jobs</option>
      <option value="5">Within 5 km</option>
      <option value="10">Within 10 km</option>
      <option value="25">Within 25 km</option>
      <option value="50">Within 50 km</option>
      <option value="100">Within 100 km</option>
    </select>
    <span id="list-filtered-count" class="badge bg-info ms-2"></span>
  </div>
  {% if jobs %}
    <div id="jobs-list-group" class="list-group">
      {% for job in jobs %}
        <a class="list-group-item list-group-item-action job-item" 
           href="{% url 'jobs:detail' job.pk %}"
           data-job-id="{{ job.id }}"
           data-location="{{ job.location }}">
          <div class="d-flex w-100 justify-content-between">
            <h5 class="mb-1">{{ job.title }}</h5>
            <small>{{ job.created_at|date:"M d, Y" }}</small>
          </div>
          <p class="mb-1">
            {{ job.location }} {% if job.is_remote %}<span class="badge bg-info text-dark">Remote</span>{% endif %}
            <span class="job-distance text-muted ms-2"></span>
          </p>
          <small>{{ job.salary_min }} - {{ job.salary_max }}</small>
        </a>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info">No jobs found.</div>
  {% endif %}
</div>

<!-- Map View -->
<div id="map-container">
  <div class="mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div>
        <button class="btn btn-sm btn-outline-primary" onclick="locateUser()">
          <i class="fas fa-crosshairs"></i> Show My Location
        </button>
        <span id="location-status" class="ms-2 text-muted"></span>
      </div>
      <div>
        <span id="jobs-count" class="badge bg-primary"></span>
      </div>
    </div>
    <div id="distance-filter-container" class="d-none align-items-center gap-2">
      <label for="distance-filter" class="form-label mb-0">
        <i class="fas fa-filter"></i> Filter by distance:
      </label>
      <select id="distance-filter" class="form-select form-select-sm" style="width: auto;" onchange="filterByDistance()">
        <option value="">Show all jobs</option>
        <option value="5">Within 5 km</option>
        <option value="10">Within 10 km</option>
        <option value="25">Within 25 km</option>
        <option value="50">Within 50 km</option>
        <option value="100">Within 100 km</option>
      </select>
      <span id="filtered-count" class="badge bg-info ms-2"></span>
    </div>
  </div>
  <div id="job-map"></div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  let map;
  let markers = [];
  let userMarker = null;
  let userLocation = null;
  const jobsData = {{ jobs_json|safe }};
  // jobsData is populated from server-side JSON
  
  // Store job coordinates for list view distance calculation
  let jobCoordinates = {};

  // Initialize map when page loads
  document.addEventListener('DOMContentLoaded', function() {
    initMap();
  });

  function initMap() {
    // Initialize map centered on a default location (can be adjusted)
    map = L.map('job-map').setView([37.7749, -122.4194], 2); // Default to San Francisco, zoomed out

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);

    // Load and display job markers
    loadJobMarkers();
  }

  async function loadJobMarkers() {
    // Clear existing markers
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];

    if (jobsData.length === 0) {
      updateJobsCount(0, 0);
      return;
    }

    let geocodedCount = 0;
    const totalJobs = jobsData.length;
    const jobsToGeocode = jobsData.filter(job => {
      // Skip jobs without location
      return job.location && job.location.trim() !== '';
    });

    updateJobsCount(0, totalJobs);

    // Geocode jobs with delay to respect Nominatim rate limits
    for (let i = 0; i < jobsToGeocode.length; i++) {
      const job = jobsToGeocode[i];
      
      try {
        const coords = await geocodeLocation(job.location);
        
        if (coords) {
          const marker = L.marker([coords.lat, coords.lon])
            .addTo(map)
            .bindPopup(createPopupContent(job));
          
          // Store job data with marker for distance calculations
          marker.jobData = job;
          markers.push(marker);
          
          // Store coordinates for list view
          jobCoordinates[job.id] = {
            lat: coords.lat,
            lon: coords.lon
          };

          // Fit map to show all markers
          if (markers.length === 1) {
            map.setView([coords.lat, coords.lon], 10);
          } else {
            const group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
          }
        }

        geocodedCount++;
        updateJobsCount(geocodedCount, totalJobs);
      } catch (error) {
        console.error('Error geocoding job:', job.title, error);
        geocodedCount++;
        updateJobsCount(geocodedCount, totalJobs);
      }

      // Add delay to respect Nominatim usage policy (1 request per second)
      if (i < jobsToGeocode.length - 1) {
        await new Promise(resolve => setTimeout(resolve, 1100));
      }
    }
  }

  function geocodeLocation(location) {
    // Use Nominatim API for geocoding (free, no API key required)
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&limit=1`;
    
    return fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error('Geocoding request failed');
        }
        return response.json();
      })
      .then(data => {
        if (data && data.length > 0) {
          const result = data[0];
          return {
            lat: parseFloat(result.lat),
            lon: parseFloat(result.lon)
          };
        }
        return null;
      })
      .catch(error => {
        console.error('Geocoding error:', error);
        return null;
      });
  }

  function createPopupContent(job) {
    const skills = job.skills ? job.skills.split(',').slice(0, 3).map(s => s.trim()).join(', ') : 'Not specified';
    const salary = job.salary_min && job.salary_max 
      ? `$${job.salary_min.toLocaleString()} - $${job.salary_max.toLocaleString()}`
      : job.salary_min 
        ? `$${job.salary_min.toLocaleString()}+`
        : 'Salary not specified';
    
    return `
      <div class="job-marker-popup">
        <h6><a href="${job.url}" target="_blank">${job.title}</a></h6>
        <p class="mb-2"><strong>Location:</strong> ${job.location || 'Not specified'} 
          ${job.is_remote ? '<span class="badge bg-info text-dark">Remote</span>' : ''}
        </p>
        <p class="mb-2"><strong>Salary:</strong> ${salary}</p>
        <p class="mb-2"><strong>Skills:</strong> ${skills}${job.skills && job.skills.split(',').length > 3 ? '...' : ''}</p>
        ${userLocation ? calculateDistance(userLocation, job) : ''}
        <div class="mt-2">
          <a href="${job.url}" class="btn btn-sm btn-primary">View Details</a>
        </div>
      </div>
    `;
  }

  function calculateDistance(userLoc, job) {
    // This will be calculated after geocoding, so we'll update popups later
    return '';
  }

  function switchView(view) {
    const listContainer = document.getElementById('list-container');
    const mapContainer = document.getElementById('map-container');
    const listBtn = document.getElementById('list-view-btn');
    const mapBtn = document.getElementById('map-view-btn');

    if (view === 'map') {
      listContainer.style.display = 'none';
      mapContainer.style.display = 'block';
      listBtn.classList.remove('active');
      mapBtn.classList.add('active');
      
      // Resize map when switching to map view
      setTimeout(() => {
        if (map) {
          map.invalidateSize();
        }
      }, 100);
    } else {
      listContainer.style.display = 'block';
      mapContainer.style.display = 'none';
      listBtn.classList.add('active');
      mapBtn.classList.remove('active');
    }
  }

  function locateUser() {
    const statusEl = document.getElementById('location-status');
    statusEl.textContent = 'Locating...';

    if (!navigator.geolocation) {
      statusEl.textContent = 'Geolocation is not supported by your browser';
      return;
    }

    navigator.geolocation.getCurrentPosition(
      function(position) {
        userLocation = {
          lat: position.coords.latitude,
          lon: position.coords.longitude
        };

        // Remove existing user marker
        if (userMarker) {
          map.removeLayer(userMarker);
        }

        // Add user location marker
        userMarker = L.marker([userLocation.lat, userLocation.lon], {
          icon: L.divIcon({
            className: 'user-location-marker',
            html: '<div style="background-color: #0d6efd; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 0 2px #0d6efd;"></div>',
            iconSize: [20, 20]
          })
        })
        .addTo(map)
        .bindPopup('Your Location')
        .openPopup();

        // Center map on user location
        map.setView([userLocation.lat, userLocation.lon], 12);

        statusEl.textContent = 'Location found!';
        statusEl.className = 'ms-2 text-success';

        // Update popups with distances and show filter
        updateMarkersWithDistances();
        
        // Also update list view with distances if visible
        updateListViewWithDistances();
      },
      function(error) {
        statusEl.textContent = 'Unable to get your location: ' + error.message;
        statusEl.className = 'ms-2 text-danger';
      }
    );
  }

  function updateMarkersWithDistances() {
    if (!userLocation) return;

    // Show distance filter container
    const filterContainer = document.getElementById('distance-filter-container');
    if (filterContainer) {
      filterContainer.classList.remove('d-none');
    }

    markers.forEach((marker) => {
      const latLng = marker.getLatLng();
      if (latLng && marker.jobData) {
        const distance = calculateDistanceKm(
          userLocation.lat,
          userLocation.lon,
          latLng.lat,
          latLng.lng
        );
        
        // Store distance with marker for filtering
        marker.distance = distance;
        
        const distanceText = distance < 1 
          ? `${Math.round(distance * 1000)}m away`
          : `${distance.toFixed(1)}km away`;
        
        // Update popup with distance
        marker.setPopupContent(createPopupContentWithDistance(marker.jobData, distanceText));
      }
    });

    // Update filtered count
    updateFilteredCount();
  }

  function filterByDistance() {
    const distanceFilter = document.getElementById('distance-filter');
    const maxDistance = distanceFilter ? parseFloat(distanceFilter.value) : null;
    
    let visibleCount = 0;

    markers.forEach((marker) => {
      if (maxDistance === null || maxDistance === '' || isNaN(maxDistance)) {
        // Show all markers
        if (!map.hasLayer(marker)) {
          marker.addTo(map);
        }
        visibleCount++;
      } else {
        // Filter by distance
        if (marker.distance !== undefined && marker.distance <= maxDistance) {
          if (!map.hasLayer(marker)) {
            marker.addTo(map);
          }
          visibleCount++;
        } else {
          if (map.hasLayer(marker)) {
            map.removeLayer(marker);
          }
        }
      }
    });

    // Update filtered count display
    updateFilteredCount(maxDistance);
    
    // Fit map to visible markers
    const visibleMarkers = markers.filter(marker => {
      if (maxDistance === null || maxDistance === '' || isNaN(maxDistance)) {
        return true;
      }
      return marker.distance !== undefined && marker.distance <= maxDistance;
    });
    
    if (visibleMarkers.length > 0) {
      const group = new L.featureGroup(visibleMarkers);
      map.fitBounds(group.getBounds().pad(0.1));
    }
  }

  function updateFilteredCount(maxDistance = null) {
    const filteredCountEl = document.getElementById('filtered-count');
    if (!filteredCountEl) return;
    
    let visibleCount = 0;
    
    if (maxDistance === null || maxDistance === '' || isNaN(maxDistance)) {
      visibleCount = markers.length;
      filteredCountEl.textContent = '';
      filteredCountEl.classList.add('d-none');
    } else {
      visibleCount = markers.filter(marker => 
        marker.distance !== undefined && marker.distance <= maxDistance
      ).length;
      filteredCountEl.textContent = `Showing ${visibleCount} of ${markers.length} jobs`;
      filteredCountEl.classList.remove('d-none');
    }
  }

  function createPopupContentWithDistance(job, distanceText) {
    const skills = job.skills ? job.skills.split(',').slice(0, 3).map(s => s.trim()).join(', ') : 'Not specified';
    const salary = job.salary_min && job.salary_max 
      ? `$${job.salary_min.toLocaleString()} - $${job.salary_max.toLocaleString()}`
      : job.salary_min 
        ? `$${job.salary_min.toLocaleString()}+`
        : 'Salary not specified';
    
    return `
      <div class="job-marker-popup">
        <h6><a href="${job.url}" target="_blank">${job.title}</a></h6>
        <p class="mb-2"><strong>Location:</strong> ${job.location || 'Not specified'} 
          ${job.is_remote ? '<span class="badge bg-info text-dark">Remote</span>' : ''}
        </p>
        <p class="mb-2"><strong>Distance:</strong> <span class="text-primary">${distanceText}</span></p>
        <p class="mb-2"><strong>Salary:</strong> ${salary}</p>
        <p class="mb-2"><strong>Skills:</strong> ${skills}${job.skills && job.skills.split(',').length > 3 ? '...' : ''}</p>
        <div class="mt-2">
          <a href="${job.url}" class="btn btn-sm btn-primary">View Details</a>
        </div>
      </div>
    `;
  }

  function calculateDistanceKm(lat1, lon1, lat2, lon2) {
    const R = 6371; // Radius of the Earth in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = 
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function updateJobsCount(geocoded, total) {
    const countEl = document.getElementById('jobs-count');
    if (countEl) {
      countEl.textContent = `Showing ${geocoded} of ${total} jobs`;
    }
  }

  async function updateListViewWithDistances() {
    if (!userLocation) return;

    // Show distance filter container for list view
    const filterContainer = document.getElementById('list-distance-filter-container');
    if (filterContainer) {
      filterContainer.classList.remove('d-none');
    }

    const jobItems = document.querySelectorAll('.job-item');
    const itemsToGeocode = [];
    
    // First pass: use existing coordinates or mark for geocoding
    for (const item of jobItems) {
      const jobId = parseInt(item.dataset.jobId);
      const location = item.dataset.location;
      
      // Try to get coordinates from stored data
      let coords = jobCoordinates[jobId];
      
      if (coords && userLocation) {
        // Already have coordinates, calculate distance immediately
        const distance = calculateDistanceKm(
          userLocation.lat,
          userLocation.lon,
          coords.lat,
          coords.lon
        );
        
        item.dataset.distance = distance;
        
        const distanceText = distance < 1 
          ? `${Math.round(distance * 1000)}m away`
          : `${distance.toFixed(1)}km away`;
        
        const distanceEl = item.querySelector('.job-distance');
        if (distanceEl) {
          distanceEl.textContent = `• ${distanceText}`;
        }
      } else if (location && location.trim() !== '') {
        // Need to geocode
        itemsToGeocode.push({ item, jobId, location });
      }
    }
    
    // Second pass: geocode items that need it (with rate limiting)
    for (let i = 0; i < itemsToGeocode.length; i++) {
      const { item, jobId, location } = itemsToGeocode[i];
      
      try {
        const coords = await geocodeLocation(location);
        if (coords) {
          jobCoordinates[jobId] = coords;
          
          // Calculate and display distance
          if (userLocation) {
            const distance = calculateDistanceKm(
              userLocation.lat,
              userLocation.lon,
              coords.lat,
              coords.lon
            );
            
            item.dataset.distance = distance;
            
            const distanceText = distance < 1 
              ? `${Math.round(distance * 1000)}m away`
              : `${distance.toFixed(1)}km away`;
            
            const distanceEl = item.querySelector('.job-distance');
            if (distanceEl) {
              distanceEl.textContent = `• ${distanceText}`;
            }
          }
        }
      } catch (error) {
        console.error('Error geocoding for list view:', error);
      }
      
      // Add delay to respect Nominatim usage policy (1 request per second)
      if (i < itemsToGeocode.length - 1) {
        await new Promise(resolve => setTimeout(resolve, 1100));
      }
    }

    // Update filtered count for list view
    updateListFilteredCount();
  }

  function filterListByDistance() {
    const distanceFilter = document.getElementById('list-distance-filter');
    const maxDistance = distanceFilter ? parseFloat(distanceFilter.value) : null;
    
    const jobItems = document.querySelectorAll('.job-item');
    let visibleCount = 0;
    
    jobItems.forEach((item) => {
      const distance = parseFloat(item.dataset.distance);
      
      if (maxDistance === null || maxDistance === '' || isNaN(maxDistance)) {
        // Show all jobs
        item.style.display = '';
        visibleCount++;
      } else {
        // Filter by distance
        if (!isNaN(distance) && distance <= maxDistance) {
          item.style.display = '';
          visibleCount++;
        } else {
          item.style.display = 'none';
        }
      }
    });

    // Update filtered count display
    updateListFilteredCount(maxDistance);
    
    // Show message if no jobs match
    const listGroup = document.getElementById('jobs-list-group');
    if (visibleCount === 0 && listGroup) {
      const noJobsMsg = document.getElementById('no-jobs-message');
      if (!noJobsMsg) {
        const msg = document.createElement('div');
        msg.id = 'no-jobs-message';
        msg.className = 'alert alert-info';
        msg.textContent = 'No jobs found within the selected distance.';
        listGroup.parentNode.insertBefore(msg, listGroup);
      }
    } else {
      const noJobsMsg = document.getElementById('no-jobs-message');
      if (noJobsMsg) {
        noJobsMsg.remove();
      }
    }
  }

  function updateListFilteredCount(maxDistance = null) {
    const filteredCountEl = document.getElementById('list-filtered-count');
    if (!filteredCountEl) return;
    
    const jobItems = document.querySelectorAll('.job-item');
    let visibleCount = 0;
    
    if (maxDistance === null || maxDistance === '' || isNaN(maxDistance)) {
      visibleCount = jobItems.length;
      filteredCountEl.textContent = '';
      filteredCountEl.classList.add('d-none');
    } else {
      jobItems.forEach((item) => {
        const distance = parseFloat(item.dataset.distance);
        if (!isNaN(distance) && distance <= maxDistance) {
          visibleCount++;
        }
      });
      filteredCountEl.textContent = `Showing ${visibleCount} of ${jobItems.length} jobs`;
      filteredCountEl.classList.remove('d-none');
    }
  }
</script>
{% endblock %}
